<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title> COUNT.surge.sh 中文版 </title>

<style>
#inputDiv {
  width: 75%;
  float: left;
  display: none
}
#showDiv {
  width: 25%;
  float: right;
  display: none
}
.yl {
  background: yellow;
}

#shareJSONDiv, #chooseSrcDiv, #chooseIdDiv {
  display: none;
}

#getcsvA {
  color: #dddddd !important;
}
</style>

</head>

<!-- CSS Style -->


<!-- Document -->
<body>
<div id="upbtn">
  <span id="tsrgBtnArea"><button id="tsrgBtn">Test Stroage</button> | </span><button id="saveBtn" disabled>保存</button> | <button id="readBtn" disabled>读取</button> | <button id="shareBtn" disabled>以 JSON 格式分享</button> | <a href="index.html">English</a>
</div>
<br>
<div id="write">
  <div id="cntDiv">
    想数 <input id="cntTxt" type="text"> 个值 .... <button id="numconfBtn">确认！</button>
    <br />
    或者 输入已有数据
    <div id="inputJSONDiv">
      <textarea id="inJSONTa"></textarea>
      <br />
      <span style="font-size: 40%"> 你输入的数据应该是由 COUNT.surge.sh 生成的有效 JSON 内容。 </span>
      <br />
      <button id="submitJSONBtn">确认！</button>
    </div>
  </div>
  <div id="shareJSONDiv">
      <textarea id="outJSONTa"></textarea>
      <br />
      <span style="font-size: 40%"> 它是 JSON 格式的。如果你想在 COUNT.surge.sh 上再次使用此数据，请保持它的原样。</span>
      <br />
      <button id="gotitJSONBtn">了解！</button>
      <hr />
  </div>
  <div id="chooseIdDiv">
  </div>
  <div id="inputDiv">
    在此输入：<input id="numTxt" type="text">
		<br>
		<button id="addBtn">+ (Enter)</button>
		<button id="dlBtn">下载 .csv 文件</button>
		<div id="getcsvDiv"></div>
    <br>
    <div id="tip">
    <b> 我能输入什么？ </b><br>
    <span> 我们支持如下格式： </span>
    <ul>
      <li>数字 (例如 5)</li>
      <li>数的区间 (例如 5-12)</li>
      <li>负数代表相应项的值减一 (例如 -2 代表把 #2 的值减去一)</li>
      <li><code>!</code> 代表回滚上次更改</li>
    </ul>
    <span> 按下 Ctrl-S ，可以把此 “应用” 存储在你的电脑上离线使用 :) </span>
    <br>
    <span> 来自有爱的 Outloudvi | <a href="https://github.com/outloudvi/count.surge.sh">GitHub</a> | ver 1.2</span>
    </div>
  </div>
  <div id="showDiv">
  </div>
</div>

<!-- And here goes the JavaScript! -->
<script>
x = undefined;
xlen = 0;
fcus = false;
xc = Array();

function e(eid) {
  return document.getElementById(eid);
}

function refreshLR(){
	y = ""
  if( xc.length != 0 )
		for (i=1;i<=xlen;i++) {
      if ( xc.includes(i) == true )
			  y = y + "<span class=yl># " + i + " : " + x[i] + "</span>";
      else
        y = y + "# " + i + " : " + x[i];
		  y = y + "<br />";
		}
  else
    for (i=1;i<=xlen;i++) {
        y = y + "# " + i + " : " + x[i];
		    y = y + "<br />";
		}
	e('showDiv').innerHTML = y;
	e('numTxt').value = "";
	e('numTxt').focus();
}

function testStorage(){
  if ( window.localStorage === false )
    e('tsrgBtn').innerHTML = "LocalStorage 不支持 :(" ;
  else {
    e('tsrgBtn').innerHTML = "LocalStorage 被支持！" ;
    e('tsrgBtnArea').style.display = "none";
    e('readBtn').disabled = false;
  }
}

function saveTo(num){
  num = Number(num);
  if ( num > 0 ) {
    console.log( "保存到存档 #" + String(num) );
    window.localStorage.setItem( "count-" + String(num) , JSON.stringify(x) );
    console.log( JSON.stringify(x) );
    e('saveBtn').innerHTML = "已保存";
  } else {
    e('saveBtn').innerHTML = "已取消";
    e('numTxt').addEventListener("focus",  (function(){e('saveBtn').innerHTML = "保存";} ) , { "once": true } );
  }
  
  for( let i=1; i<=5; i++ )
  {
    istr = String(i);
    e('choose' + istr + 'Btn').removeEventListener('click',false);
  }
  e('cancelBtn').removeEventListener('click',false);
  e('chooseIdDiv').innerHTML = "";
  e('chooseIdDiv').style.display = "none";
}

function saveData(){
  let x = "";
  for( let i=1; i<=5; i++ )
  {
    istr = String(i);
    if( window.localStorage.getItem('count-' + istr ) === null )
      x = x + "<button id='choose" + istr + "Btn'>存档 #" + istr + " (并没有内容)" +"</button>";
    else {
      let xlen = JSON.parse(window.localStorage.getItem('count-' + istr)).length;
      x = x + "<button id='choose" + istr + "Btn'>存档 #" + istr + "  有长度为" + String(xlen) +"的数据</button>";
    }

    x = x + " | ";
  }
  x = x + "<button id='cancelBtn'>取消</button>";
  e('chooseIdDiv').innerHTML = x;
  e('cancelBtn').addEventListener('click', (function(){ saveTo(0); }) );
  console.log(x);
  e('chooseIdDiv').style.display = "block";
  for( let i=1; i<=5; i++ )
  {
    let istr = String(i);
    e('choose' + istr + 'Btn').addEventListener('click', (function(){ saveTo(istr) }) );
  }
  e('saveBtn').innerHTML = "保存到...";
}

function readFrom(num){
  if ( num > 0 ) {
    x = JSON.parse(window.localStorage.getItem( "count-" + String(num) ) );
    e('readBtn').innerHTML = "已加载";
    xlen = x.length - 1;
    if ( e('cntDiv').style.display = "block" )
    {
      e('cntDiv').style.display = "none";
	    e('inputDiv').style.display = "block";
	    e('showDiv').style.display = "block";
    }
    refreshLR();
  } else {
    e('readBtn').innerHTML = "已取消";
    e('numTxt').addEventListener("focus",  (function(){e('readBtn').innerHTML = "加载";} ) , { "once": true } );
  }

  for( let i=1; i<=5; i++ )
  {
    istr = String(i);
    e('choose' + istr + 'Btn').removeEventListener('click',false);
  }
  e('cancelBtn').removeEventListener('click',true);
  e('chooseIdDiv').innerHTML = "";
  e('chooseIdDiv').style.display = "none";

}

function readData(){
  let x = "";
  for( let i=1; i<=5; i++ )
  {
    istr = String(i);
    if( window.localStorage.getItem('count-' + istr ) === null )
      x = x + "<button id='choose" + istr + "Btn'>存档 #" + istr + " (并没有内容)" +"</button>";
    else {
      let xlen = JSON.parse(window.localStorage.getItem('count-' + istr)).length - 1;
      x = x + "<button id='choose" + istr + "Btn'>存档 #" + istr + "  有长度为" + String(xlen) +"的数据</button>";
    }

    x = x + " | ";
  }
  x = x + "<button id='cancelBtn'>取消</button>";
  e('chooseIdDiv').innerHTML = x;
  e('cancelBtn').addEventListener('click', (function(){ readFrom(0); }) );
  e('chooseIdDiv').style.display = "block";
  for( let i=1; i<=5; i++ )
  {
    let istr = String(i);
    e('choose' + istr + 'Btn').addEventListener('click', (function(){ readFrom(istr) }) );
  }
  e('readBtn').innerHTML = "从...读取";
}

function initList(num){
	xlen = num;
	num = Number(num);
	x = new Array(num+1);
	for ( i=0;i<=xlen+1;i++ ){
		x[i] = 0;
	}
}

function min(a,b){
  if (a<=b) return a;
  return b;
}

function max(a,b){
  if (a>=b) return a;
  return b;
}

function inc(num,flag=true){
  if (flag) {
    x[num] = x[num] + 1;
    xc.push(num);
  } else {
    x[num] = x[num] - 1;
    xc.push(num);
  }
}

function rollback(){
  for( i in xc)
    inc(xc[i],false);
}

function proc(str){
	
  e('numTxt').placeholder = "";

  if ( /^[0-9]+$/.test(str) ){ // Only a num
    str = Number(str);
    inc(str);
    x = x.slice(0,xlen+1);
    return;
  }
	
  if ( /^[0-9]+-[0-9]+/.test(str) ) {  // A - B
    str = str.split('-');
    str[0] = Number(str[0]);
    str[1] = Number(str[1]);
    xfrom = min( str[0], str[1] );
    xto = max( str[0], str[1] );
    for (i=xfrom;i<=xto;i++)
      inc(i);
    x = x.slice(0,xlen+1);
    return;
  }
	
  if ( /^-[0-9]+/.test(str) ) {
    str = str.slice(1);
    str = Number(str);
    if( str<=0 ) return;
      inc(str,false);
    x = x.slice(0,xlen+1);
    return;
  }
	
  e('numTxt').placeholder = "指令识别失败。";

}

function addNum(){
	num = e('numTxt').value;
	
  if ( /!/.test(num) ) {
    rollback();
    refreshLR();
		xc = Array();
    return;
  }
	
	xc = Array();
	
  num = num.split(',');
	
  for ( i in num )
    proc( num[i] );
	
	refreshLR();

}

function getBlob(){
	y = ""
		for (i=1;i<=xlen;i++) {
			y = y + i + "," + x[i];
		  y = y + "\n";
		}
	blob = new Blob( [y] , { type: 'text/comma-separated-values', endings:'transparent' } );
	url =  URL.createObjectURL(blob);
	e('getcsvDiv').innerHTML = "<a id=getcsvA download='count.csv' href=' " + url + " '>点此下载 CSV</a>";
  e('getcsvA').click();
}

function gotJSONData(){
  let p = e('inJSONTa').value;
  x = JSON.parse(p);
  e('cntDiv').style.display = "none";
	e('inputDiv').style.display = "block";
	e('showDiv').style.display = "block";
  xlen = x.length - 1;
  refreshLR();
  document.addEventListener("keydown", keyCheck );

}

function cntConfirm(){
	e('cntDiv').style.display = "none";
	initList( Number(e('cntTxt').value) );
	e('inputDiv').style.display = "block";
	e('showDiv').style.display = "block";
  refreshLR();
  document.addEventListener("keydown", keyCheck );
}

function shareByJSON(){
  let r = JSON.stringify(x);
  e('outJSONTa').value = r;
  e('shareJSONDiv').style.display = "block";
  e('gotitJSONBtn').addEventListener("click", ( function(){ e('shareJSONDiv').style.display = "none"; } ) );
}

function keyCheck(event){
  if( fcus ) return;
  key = event.key;
  console.log(key);
  if ( key == 'Enter' ) {
    e('addBtn').click();
    return;
  }
  p = e('numTxt').value;
  if ( key == "Backspace" ) {
    e('numTxt').value = p.slice(0,p.length-1);
    return;
  }
  if( /^[0-9\-!]+$/.test(key) )
  {
    e('numTxt').value = e('numTxt').value + key;
    return;
  }
}

e('tsrgBtn').addEventListener("click", testStorage);
e('numconfBtn').addEventListener("click", cntConfirm);
e('addBtn').addEventListener("click", addNum);
e('dlBtn').addEventListener("click", getBlob);
e('saveBtn').addEventListener("click", saveData);
e('readBtn').addEventListener("click", readData);
e('numTxt').addEventListener("focus", (function(){fcus = true;}) );
e('numTxt').addEventListener("blur", (function(){fcus = false;}) );
e('numTxt').addEventListener("keydown", (function(g){if(g.key=='Enter') e('addBtn').click();}) );
e('submitJSONBtn').addEventListener("click", gotJSONData);
e('shareBtn').addEventListener("click", shareByJSON);
e('numTxt').addEventListener("focus",  (function(){e('saveBtn').disabled=false; e('shareBtn').disabled=false;} ) , { "once": true } );

testStorage();

</script>
	


</body></html>